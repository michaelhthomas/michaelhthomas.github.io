{"hash":"98ace08a18a96d1bfff424631bc69d4013acad0c","data":{"post":{"id":"896fdecc9214fb770ee45bdd4ac19264","title":"Using ZSH with Toolbox on Fedora Silverblue 33","path":"/blog/using-zsh-with-toolbox-on-fedora-silverblue-33/","date_published":"November 19, 2020","date_updated":"April 5, 2021","timeToRead":3,"tags":[{"id":"Fedora Silverblue","title":"Fedora Silverblue","path":"/tag/Fedora%20Silverblue/"},{"id":"Linux","title":"Linux","path":"/tag/Linux/"}],"description":"Setup your own customized shell within Fedora Toolbox, all while maintaining convenience features from the default shell.","content":"<p>Fedora Silverblue is one of the most interesting Linux distros I have tried to date, and I ended up choosing to use it as my daily-driver for its stability, ease of updates, and cleanliness. However, one of my biggest must-haves was a proper, customized shell. </p>\n<p>My personal choice of shell is ZSH with the <a href=\"https://github.com/zimfw/zimfw\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Zim Framework</a>, giving me a fast and simple shell experience without too much hassle. However, the basic installation steps for these differ a bit on Fedora Silverblue. </p>\n<h2 id=\"installation\"><a href=\"#installation\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Installation</h2>\n<p>First, install <code class=\"language-inline-text\">zsh</code> as a layered package on the host system with rpm-ostree:</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=michael data-host=pc></span></span><span class=\"token function\">sudo</span> rpm-ostree <span class=\"token function\">install</span> <span class=\"token function\">zsh</span></code></pre></div>\n<p>After doing so, go ahead and reboot to enter the new ostree deployment, which will now contain zsh.</p>\n<p>Next, we’ll go ahead and install zsh in toolbox. Enter the toolbox with <code class=\"language-inline-text\">toolbox enter</code> and then install <code class=\"language-inline-text\">zsh</code> the old fashioned way:</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=michael data-host=pc></span></span><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> <span class=\"token function\">zsh</span></code></pre></div>\n<p>Now that we’ve got zsh installed everywhere, type <code class=\"language-inline-text\">exit</code> to get back to the host system. Since <code class=\"language-inline-text\">chsh</code> is not included on Silverblue, we’ll use <code class=\"language-inline-text\">usermod</code> instead to switch to our shiny new shell:</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=michael data-host=pc></span></span><span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> --shell <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">which</span> <span class=\"token function\">zsh</span><span class=\"token variable\">)</span></span> <span class=\"token environment constant\">$USER</span></code></pre></div>\n<p>Alternatively, Fedora offers <code class=\"language-inline-text\">lchsh</code> which provides a similar interface to <code class=\"language-inline-text\">chsh</code> on other Linux systems. </p>\n<p>Start a new shell and you should be greeted by the ZSH first time configuration, which will look something like this:\n<img class=\"g-image g-image--lazy g-image--loading\" src=\"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 869 451' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-85dec52373f77aba650daaeba6fe6883'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-85dec52373f77aba650daaeba6fe6883)' width='869' height='451' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAhCAYAAABpwa0hAAAACXBIWXMAAAsSAAALEgHS3X78AAAL/UlEQVRogZ3Z2W4kxxEFUH6BHwwbsKQRh%2bsMd7LZbO77vpNDzow0WgwB9o8YejH002mcyIpmiSApyg%2bFrso1MvLeG5HZAx%2b/%2b74cnpyV2/tP5fzquuwdHpdOb7lc3X4ox%2bcX5eD4tMx2FsvlzW25ur0rC91etOutrpeVja3y6fsvZf/4pMx1uuXm7r4cnp5FH/0PT07LyflFPEur6%2bXDx0/l5Pyy7BwclrPLq3JxfVN6a%2btlbGKqjLybKKPvJ198nmrTLnvu/aVnYHpuocx3e2V1YyuMmVtcimd9e6cs9lZiwZOz86W3tlGWVtfivbuyVsYnp8vU3HwsrLO0HItYXF4p893af21zO9p1V1ZjwTMLi/G7sLQcj36cOLuw2DfGGJ7XGD6W7ZvfdvmfcsDgyFj5dni0fDs8Vry/GRqJ5%2bvBoSj/5u1w1H096Hc02qjz%2b3Z0vHz9dji%2bh8ffRzt9o18zTnusr7592%2b%2bXbQdHxsPYWjba75/t1A2NvYtvj3l8V5sfnlpfx1D/WicMrG/tlI3t3TIxM1feTc2U7b2DsrW7Xw5OTsvW3n7ZPTgq2iiziysbm2X/6CTaeddG2%2bn5Tlle3wgKdZdXy/LaRtnc2Qsk7OwfBqK29w8CNeaCOu3mF5diB411dHZezi6vy97RcaBFf/XsM5/%2bMwudsrDUC5qh2/7RcTm/uon22imDZM57FQJWNrbKxk51AENQwWKVrW5ulasPd2V9ezcWArqMYgiDLcricBv0p%2bYWwngG0I0NbRm%2bdxDjbu7ulaWVtZinashmUMROcZhFHZ9dhPbQFfOjHHssMLRmcanMdrrhdHpydHoefdStbW1H305vpY%2bCP3TA0Ni7aAxaeE3grj/chTc93o/PzkMkLYAYWowdvL67L5e3H8rkzFy8cwThY7hF2gULNAZRJHp26/b%2bY8zDUO/q1RFk5cajJ2nXYwoE3frUfaBA0uhPUWC0JRqMBjm7CRHT8wshcKDP6wldSOAssFfu3S942rHJ2Uon43pX58mxtDO28XzPNXWopm4qxpjvi%2bJz4viSYL5aBIfGqod18BChb96OhDc9RDC9q5y4teveDFWP65c7oP3Q%2bPv%2brqWYZtvc0b5gvh2Ocb8aHOqP3e7rSUHMhf3RAl/tgI3t3eARj7%2bbmi7n1zchRnaEwIE1fgqH4Lp7cBi7ifviPtE6Oj0LPtINXCScNIBY4i5uJ63AFzqU1/GOIg8hZtqsbm4HhVAFndiDdjQoQyznvmZxr3JAd2UtJnw/PROQMhGuW6TJiJ58gIMInEWANadYhDKaQNAIHGGUL8gvLE6dmK8tPTAHymhjHvkFkdOOuJoTzQgaW2wGB4sYc4vdENrXouDVecCboZHYmaSA2P6mFfMT1qCa3zU3GIoncoUGslEWucNo5A45/j/eDAbMh5uYH7DvtxtqcoYK98wdjCN30K9NiaSDBbA7KZP0ye%2bs65e1ynO9A3YN1AmSnQFBYUzosgNi%2b%2bLyauwUgSRUEEO81EGE9kTNThsrwuT6Zlle3wzk%2bJUf6Gce46GQ8fW1%2b1Q/20IGVHg3XuYM2da8bLUIeQXUaQdV6tjBLoKalILYCN1bO9FnZr5TJqZnywAjcDBVF1TFVb%2bM/O6HH4PDvg28e3gU3DeRvnjrCRUXNu/ug79nV9fl9OIyIA3CGepAmDb4ZrTn9KKeC7StYfi%2b3Nx/DF0xnsTH3HTi9PIqxkVRDrARaOhsYRx1NM04dOvg%2bCTGEcqdW9hu04PWM3NlIJW7TYEK2wq1TDvju3nPSKAs2yXERIpU7nZkSMWPfq26duyOaNJv%2bxB50Cth3Y8yTY7gaUeU%2bG1RpZ0jZP6Qax1BAR7MuA4BIAKmdsPvxMxsjdWL3fJ%2bejbEzW4HlHsrsRPKHWrsLvWn8vW9xn/9fWtnV1CJ%2bBJTZZlnQKH3RCMDQR%2bd5ByRZzQpOwjLFzIfUVfX0qt2KmvyFLY%2bJ5gDlBosGGhgqSTogygngBfofPnp5zgmgy%2bD8FKIEgY55Ief/xltQc6kIHf/%2bbsoF0o51mLuPn0OitAJTsP1z19%2biPAJvupREk8Joc1BCdAXDs2d4ZmuWLAs8/sff4oyVKIdFs1u9G0ftx87YiChkJkgQYkdWVgMITEA7r2fmumLCwNMQigtmKjZGaFLndAZB5j9gygjThwXYrayGppAlMyDnxZP%2bKTGxmI8Z8o5zJ1iaWOS%2b20lz0WxP8set3kubA60MydwYgz4KLMIiwZ/A1mM05byONzs7MXOEESLgSZPKnlEiObixO45HKUIquMQDtxpDlc1kqxFG86ABLtMgM2nn7n%2bn3j/LAWGmrQ0PRln/RCnWp7ik%2bnu47wgz/iRFzRxnZB5J2ApXPoR0XpvkKmx8WoOoc/DXFWspMY5X87dFue8R8gcIcvbsd986YAnEbDU5AF2nwbYObzCV9/KQ7ga%2bGpPXKAEIkAT/IkatMgoaYJyu6Wv77xNYpD4G3nA1nbstDkIasZ67cwHFeK4b3lCZIybW6FFxqwZ5XroApSpMx/UsVX/lwRwlAPwlOClIoul7vBQIflItNwHSktv7j5Gm4zZFze3IVTER27P8Bgj4vFZwFe7n3/5JWBsUo7ldO0JGF4bH31Qg3M5iCASNotHvThXnJxGzGc32wi4XIWQXt58iDp0I8LyARTiqOeoMJCxMiHycL1UYR9lGX8bWOnoPeN90ki7zBvaaaurqkxL27E784%2bkRTtVzXFQpQ3zdj5R7R3rn1IfnyDT/swZnhLDAV4EYV5SkXG73gd0Qln92nGnRSip8boTYuU902g7m3Xe9ZNH5NlfXcT75l0bdMi6zB3SFmXmVZ5Xdr5zfLYpr/nGYvTzzcYM68aQuyh7EgG7B0cBxVys2O32B4SEOQOAFm1Qn2ksKKoXxuQIaICLGecZBbbo5FiL65kWi/ceCZEosra1E1BGu0rH%2bRBXuvHLv/4d9DKfRYI1itUzwlK0l2OIPLTJ3NrXq7LzoBIb0ULilKLYd8D4ZN3VLIhL0h0HicUQJrHY4sVij7OAiQmR8nqeP43ExXdcfXd7ESIjFO7sxpi%2bGRhHbOM1ZXkosnN4nflF3C0cHYcdHEEw7ar2nMjBRM9Ychft4xK12%2btfyNYD1UZsXN5QvZgIvZuaCW8RJtdUDCMq/cRm76B8%2bfGnGgncEK/Xm9zI6jrd%2bDWpk6P4fnF9G4iJW%2bT9g3qoWVmLPhZy0E%2bAamoNFQxWzqlQEchqTnEoWC9w6uENCiRMe4dH4SDoYzPb8oTo9/EfL7/TgNFHhSALrhYHdnYYVO0cKhgUBzlpa3cvkhXhSx%2bpMQRInPTVT5gSETiBUzlTdhmwPj6NhVuU22dOyhskp8mMGnHjdHEZcOcY39t7%2b2FzCl9bhN0YtXOBlxKigccVPJ7CIrbjXYpQ8Kw5rFg0R4i3ITTznYjhHEfkMk7X/MA/RGtBNfQxttAWucbkdJNjVFTFv0ZNbiIMh/B1uhHbja%2bdvlL1py5O2xeoj7%2bfTISGWpmgggwzGcry352HS9CR8PLDLU5ebD4cR%2bMfo8Gh/hH34RL04Wiat0sZhvNCNDLMVqjLsWrmmZlotStDX//Y3jouR5bYzKvfcxnhgEyLWvOmAioK9jgqfOQFCcGxK/XyZC4U2zuoSzYC8t16hxinwpPT2EmGQQ%2bIgy4qgXxw9%2bi4L1ZsILrq0aWqftWhUPC5%2bXoeOD4JarHLeITSeISXQOvLHjbiPzrpD0WPI8BopsLCRZ7LdU415hSO4BDQ9M7o%2bWayUN/t3RAyC9CHABKtKnr1T9P4x2lzK9qgk0XGX3BxjbUeEcE4NIaQ6Q/y%2bUesRbMPZRycOIZNNCGv3%2bK6bnuniTDbQR19tacb%2bjxJgYm49Kj5skF5ixE5sUlMYHcIHy8SqNuPnyLB8S6NFT1MkiFPKJLG2iXpMhGDAv8kQZR3Y%2ba11t%2b%2b%2bqb859dfy39/%2b6385a9/7x9p8wap/QdqO/NMqrT/PepToHUb5YD1JAVGG7HI%2b4Cq6Mv9W53MCmV06ah6S1Szsfy3yJN/mYeIErRu7yHLa/7tMWb%2bo6TO/OOT9W80cLZbUuLf/eX9wj9AYxN/fBR%2bSQT/B5e5CHV%2bpXyeAAAAAElFTkSuQmCC' /%3e%3c/svg%3e\" width=\"869\" alt=\"Zsh first time config\" data-srcset=\"/assets/static/image.82a2fbd.634d41da8b4ced823678122f9c298cb9.png 480w, /assets/static/image.372248f.634d41da8b4ced823678122f9c298cb9.png 869w\" data-sizes=\"(max-width: 869px) 100vw, 869px\" data-src=\"/assets/static/image.372248f.634d41da8b4ced823678122f9c298cb9.png\"><noscript><img class=\"g-image g-image--lazy g-image--loaded\" src=\"/assets/static/image.372248f.634d41da8b4ced823678122f9c298cb9.png\" width=\"869\" alt=\"Zsh first time config\"></noscript>\nIf you’ve made it here, congratulations! Zsh is now installed and working.</p>\n<h2 id=\"customization\"><a href=\"#customization\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Customization</h2>\n<p>Silverblue’s default bash shell contains some important tweaks which, for example, provide the purple indicator present when inside the toolbox. These tweaks are a must-have for me, so I’ll be implementing them in my prompt theme for zsh. First, though, I’ll install my zsh framework of choice, Zim: </p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=michael data-host=pc></span></span><span class=\"token function\">curl</span> -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh <span class=\"token operator\">|</span> <span class=\"token function\">zsh</span></code></pre></div>\n<p>These next steps may differ a bit depending on the framework you choose, but the principles are the same. Currently, there is no way of knowing whether or not the shell is running inside toolbox, so we’ll start by fixing that. </p>\n<p>The default Silverblue bash config uses a function that looks something like this to return whether or not toolbox is active: </p>\n<div class=\"gridsome-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -f /run/.containerenv <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">[</span> -f /run/.toolboxenv <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">printf</span> <span class=\"token string\">\"\\[<span class=\"token entity\" title=\"\\033\">\\033</span>[35m\\]⬢\\[<span class=\"token entity\" title=\"\\033\">\\033</span>[0m\\]%s\"</span> <span class=\"token string\">\"[\\u@\\h \\W]<span class=\"token entity\" title=\"\\\\\">\\\\</span>$ \"</span><span class=\"token variable\">)</span></span></code></pre></div>\n<p>In other words, the presence of /run/.containerenv and /run/.toolboxenv is what indicates that the shell is running inside toolbox. We can use this in our zsh config to append the purple ⬢ symbol, albeit a bit more elegantly.</p>\n<p>I took my prompt theme of choice, gitster, and duplicated its folder in ~/.zim/modules (this process will be similar for oh-my-zsh and others). I then edited my new prompt theme and added a function to detect the toolbox:</p>\n<div class=\"gridsome-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function-name function\">_prompt_toolbox</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -f /run/.containerenv <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">[</span> -f /run/.toolboxenv <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    print -n <span class=\"token string\">\"%F{magenta}⬢ \"</span>\n    <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This function uses the same detection logic as the bash version, and uses the much more elegant <code class=\"language-inline-text\">%F{}</code> zsh color syntax to switch the color to magenta before outputting the ⬢ character. Next, when the prompt variable, PS1, is defined at the end of the theme file, I added a call to <code class=\"language-inline-text\">_prompt_toolbox()</code> at the beginning, resulting in the proper output of the indicator if and only if toolbox is active. </p>\n<div class=\"gridsome-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token string\">'$(_prompt_toolbox)%(?:%F{green}:%F{red})➜ $(_prompt_gitster_pwd)${(e)git_info[prompt]}%f '</span></code></pre></div>\n<p>Now, time to test it out! I saved my new custom theme and enabled it in <code class=\"language-inline-text\">~/.zimrc</code>. After running <code class=\"language-inline-text\">zim compile</code> to build my new theme, I restarted zsh and was greeted with the same prompt as before. This time, though, entering the toolbox presented that small, purple indicator; finally giving me the beauty of a custom shell combined with the helpful utility that Silverblue’s default configuration provides. </p>\n","cover_image":{"type":"image","mimeType":"image/png","src":"/assets/static/prompt.07cc2b7.73ba7a3035430c02dbb55962aa1a518c.png","size":{"width":860,"height":430},"sizes":"(max-width: 860px) 100vw, 860px","srcset":["/assets/static/prompt.a67b0b2.73ba7a3035430c02dbb55962aa1a518c.png 480w","/assets/static/prompt.07cc2b7.73ba7a3035430c02dbb55962aa1a518c.png 860w"],"dataUri":"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 860 430' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-e5279e4abb46ccb7e26991fee3c2d3be'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='10'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-e5279e4abb46ccb7e26991fee3c2d3be)' width='860' height='430' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAgCAYAAACinX6EAAAACXBIWXMAAAsSAAALEgHS3X78AAADqElEQVRogeWW3U4bRxTH5wlqinHsnZ3Z9a53ba8/WqVAL4IRJnZJiG0IsBiiOHzkpsjYkaqQmyoXvUPiLi/R9%2bFFeIV/NbPe2FCcOK2ioyhIP83OmTnsf87OOcfMsix8zzBqAdQwagHUMGoB1DBqAdQwagHUMGoB1DBqAdQwagHUMGoB1DBqAdQwagFfCymlHm3bvjWfOQBywkE/y/vXpu7/j4I/5f%2b5PXdtam6a5kf7fT7scy%2b6NbenH0BFWgihsUf74ujH4zS/yXXlf1vDv33laM/kmpzQyoWEEBKOk0WhUIDjOLPfADnaKKQJLgyYkkd2U0CmDEgjiijnXItVoyKTycB1XY1hGNqWTqf1czxybn5cm9yjfNWz%2blq%2b74%2b/GOeQRgZSfUX1zI3o8J4HKczxmmnCklL7qeBXix4yD1J42evh5uYGFxcXmJ%2bfRzabneUG2DCEgZ9yD/Fh/W/Ugw1kzAewCx6cvRrsxiJsLtDutNFoPMb6el2Pu7s7ePHiEIeHB6jX69je3sLr16fY3dnB8vISVlYeIQz3sLn5FPv7oV5vt1o4Onql/TqdtrYPh%2bfwPB8ik4ZT/w3udhfZWl3jNJ4iu/oYucNj2L8sw23vIbuyBvfZc9ieD8PgeFjy8EdYQ3L%2bR/T7fai/y8tLzM3N6ZswUwpwwVF2q/ir9gGPCmvImOkoAOEqrI0l%2bLaLXu8lVldrGAz6%2bgCnpyfY2uqg1XqmD6Lm79//ieOjV1haXMSTJxsYnPd1UNThVcBOTo7x7uIt3rwZYjg4x8FBF93uPopBAJFKwe2EyB39Dvd5F7n9nj6w09zUgXDWGsgdHMPZaMFpbMISJgxToPlrGa3az/ghkcBwONABuLq6QiKRmC0AciIFUmZSByO6jgIyzWFxoa9qsVhEqVRCUCyiXCqhWq3qXK5Uysjn85pcLqdJJpOoVCpoNpvwfQ%2blUqCvo/ofSpTK03a7pd8TBIGeC3WtXTciX4BVCGAH5Wju52F5fjQWA1j5YpQSlgU3a8OUFlKpFMIwxPX1Nc7OzrCwsDBrCljjFjIqMpNFMC42Kggqp6MxqgNxbVA2xbgoRgVS5Xq8FlfoeI%2bqBbFNERc7zSjPpcnHNk1sj/arOiAmip3SooKv6s0XdQHrbsv5n23ubk%2be1g0%2b1YlmeYe8p1XHX/2LfwdY3zhTW/n3EgBrRhi1AGoYtQBqGLUAahi1AGoYtQBqGLUAahi1AGoYtQBqGLUAahi1AGr%2bATHnBDXKR7SBAAAAAElFTkSuQmCC' /%3e%3c/svg%3e"},"cover_image_caption":null}},"context":{}}